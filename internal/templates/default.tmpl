job "nginx" {
    datacenters = ["dc1"]
    type = {{ .JobType }}
    namespace = "default"

    meta {
        run_uuid = "{{ .DeployVersion }}"
    }

    group "nginx" {
        count = 1

        network {
            port "http" {
                static = 8080
            }
        }

        scaling {
            enable = true
            min = 1
            max = 6
        }

        service {
            name = "nginx"
            port = "http"
            tags = ["nginx"]
        }

        restart {
            attempts = 10
			interval = "5m"
			delay = "25s"
			mode = "delay"
        }

        task "nginx" {
            driver = "docker"
            force_pull = true

            ports = ["http"]

            volumes = [
                "local:/etc/nginx/conf.d"
            ]

            template {
                data = <<EOF
                    upstream backend {
                        {{ range service "$ENV_NAME_SERVICE" }}
                            server {{ .Address }}:{{ .Port }};
                        {{ else }}server 127.0.0.1:65535; # force a 502
                        {{ end }}

                        server {
                        listen 8080;

                        location / {
                            proxy_pass http://backend;
                        }
                    }
                EOF
                estination = "local/load-balancer.conf"
                change_mode = "signal"
                change_signal = "SIGHUP"
            }

            resources {
                cpu = 1000
                memory = 1000
			}
        }
    }
}